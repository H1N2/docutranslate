# DocuTranslate 新手引导与核心类说明

## 一分钟上手
- 安装：`pip install docutranslate` 或 `pip install docutranslate[docling]`
- 启动：`docutranslate -i`（默认端口 `8010`），或 `docutranslate -i -p 8011`
- 打开：浏览器访问 `http://127.0.0.1:8010`，API 文档 `http://127.0.0.1:8010/docs`

## 核心流程（面向小白）
1. 选择文件并确认类型（PDF/Word/TXT/JSON 等）
2. 填写 LLM 配置：`base_url`、`api_key`、`model_id`、目标语言
3. PDF 解析引擎二选一：在线 `mineru`（需 token）或本地 `docling`
4. 可选：开启自动术语表或上传术语字典，设置并发/分块
5. 提交任务，查看实时日志与进度
6. 完成后下载导出文件（`html`/`md`/`docx`/`xlsx` 等）与附件（术语表）

## 工作流总览（选择对的管道）
- `MarkdownBasedWorkflow`：富文本文件统一转 Markdown 再翻译与导出
- `TXTWorkflow`：纯文本分段翻译
- `JsonWorkflow`：基于 JSONPath 的选择性翻译
- `DocxWorkflow`：保留 Word 格式翻译
- `XlsxWorkflow`：表格结构保留与单元格翻译
- `SrtWorkflow`/`AssWorkflow`：字幕时间戳与对话结构保留
- `EpubWorkflow`、`HtmlWorkflow`：标签感知与结构维护

## 关键类与配置（按职责分）

### Workflow（管道总控）
- 位置：`docutranslate/workflow/`
- 抽象：`Workflow`（`base.py`）定义统一接口：
  - 读取：`read_path()`、`read_bytes()`
  - 翻译：`translate()`、`translate_async()`（推荐异步并发）
  - 导出：`save_as_*()` 与 `export_to_*()`（返回字符串）
- 实现：各格式对应 `*_workflow.py` 与 `*WorkflowConfig`

### Converter（文档→标准化）
- 位置：`docutranslate/converter/x2md/`
- `ConverterMineruConfig`：在线 PDF 解析（需 `mineru_token`，支持公式/表格/代码）
- `ConverterDoclingConfig`：本地 PDF 解析（首次下载模型，离线更稳定）

### Translator（翻译引擎）
- 位置：`docutranslate/translator/ai_translator/`
- 常见配置类：
  - `MDTranslatorConfig`（Markdown）
  - `TXTTranslatorConfig`（TXT）
  - `JsonTranslatorConfig`（JSON）
  - `DocxTranslatorConfig`、`XlsxTranslatorConfig`
  - `SrtTranslatorConfig`、`EpubTranslatorConfig`、`HtmlTranslatorConfig`、`AssTranslatorConfig`
- 共同要点：`base_url`、`api_key`、`model_id`、`to_lang`、`concurrent`、`chunk_size`
- 术语：`GlossaryAgentConfig`（自动术语生成与术语对齐）

### Exporter（导出器）
- 位置：`docutranslate/exporter/`
- 常见：`MD2HTMLExporterConfig`、`TXT2HTMLExporterConfig`、`Json2HTMLExporterConfig`、`Docx2HTMLExporterConfig`、`Xlsx2HTMLExporterConfig` 等
- 作用：输出 `html/md/txt/json/xlsx/csv/docx/srt/epub/ass` 文件或内容字符串

## 最小可用示例
```python
# 中文注释：PDF→Markdown→翻译→导出（异步）
import asyncio
from docutranslate.workflow.md_based_workflow import MarkdownBasedWorkflow, MarkdownBasedWorkflowConfig
from docutranslate.converter.x2md.converter_mineru import ConverterMineruConfig
from docutranslate.translator.ai_translator.md_translator import MDTranslatorConfig
from docutranslate.exporter.md.md2html_exporter import MD2HTMLExporterConfig

async def main():
    # LLM 配置（请替换为你的凭据）
    translator = MDTranslatorConfig(
        base_url="https://open.bigmodel.cn/api/paas/v4",
        api_key="YOUR_API_KEY",
        model_id="glm-4-air",
        to_lang="English",
        chunk_size=3000,
        concurrent=10,
    )
    # 在线 PDF 解析（mineru）
    converter = ConverterMineruConfig(mineru_token="YOUR_MINERU_TOKEN", formula_ocr=True)
    # 主工作流配置
    config = MarkdownBasedWorkflowConfig(
        convert_engine="mineru",
        converter_config=converter,
        translator_config=translator,
        html_exporter_config=MD2HTMLExporterConfig(cdn=True)
    )
    flow = MarkdownBasedWorkflow(config=config)
    flow.read_path("path/to/file.pdf")
    await flow.translate_async()  # 小文件也可用同步 flow.translate()
    flow.save_as_html(name="out.html")

if __name__ == "__main__":
    asyncio.run(main())
```

## Web 与 API（面向集成）
- 启动：`docutranslate -i [-p 8011]`
- 交互界面：`http://127.0.0.1:8010`
- API 文档：`http://127.0.0.1:8010/docs`
- 关键端点：
  - `POST /service/translate`（提交任务，返回 `task_id`）
  - `GET /service/status/{task_id}`（查询状态与可下载项）
  - `GET /service/logs/{task_id}`（增量日志）
  - `GET /service/download/{task_id}/{file_type}`（下载结果）
  - `GET /service/attachment/{task_id}/{identifier}`（下载附件，如术语表）
  - `GET /service/content/{task_id}/{file_type}`（Base64 JSON 内容）
  - `POST /service/cancel/{task_id}` / `POST /service/release/{task_id}`

## 常见坑位
- **PDF→Markdown会丢失排版**：排版严格的场景需后处理或选用原格式工作流
- `mineru` token 14 天有效期；网络不佳建议改用 `docling`
- LLM 三件套必须匹配平台：`base_url`/`api_key`/`model_id`

## 品味自检（简洁与消除分支）
- 工作流只做一件事：读、译、导出；避免在一个函数里混杂多责任
- 配置组合替代 if/else：通过不同 `*Config` 让特殊情况自然消失
- 减少缩进与长函数：示例函数尽量 <20 行，职责清晰