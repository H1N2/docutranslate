# 在线文本翻译与主页配置同步 - 实现说明（2025-11-09）

## 概述
- 目标：使在线文本翻译页面（`/text`）的 LLM 配置与主页当前配置保持一致，同步且可回退。
- 范围：配置读取、同步策略、请求构造与 UI 尺寸调整。

## 实现项
- 默认勾选“使用主页配置”（元素`#use_home_cfg`）：初始化时调用`applyHomeCfg()`并禁用输入框（`#llm_base_url`、`#llm_api_key`、`#llm_model_id`）。
- 实时同步：监听`storage`与`visibilitychange`事件，在勾选情况下自动调用`applyHomeCfg()`更新输入框。
- 平台感知同步：
  - 读取“当前平台”指示键（候选：`translator_platform_selected`、`dt_selected_platform`、`ai_platform`、`llm_platform`）。
  - 若无显式键，兜底从现有`translator_platform_{平台}_apikey/_model_id`推断平台。
  - `base_url`解析：
    - `custom`平台使用`translator_platform_custom_base_url`。
    - 非`custom`平台使用内置映射表解析：`openai`→`https://api.openai.com/v1`、`zhipu`→`https://open.bigmodel.cn/api/paas/v4`、`moonshot`→`https://api.moonshot.cn/v1`、`deepseek`→`https://api.deepseek.com/v1`、`siliconflow`→`https://api.siliconflow.cn/v1`、`volcengine`→`https://api.maas.volcengineapi.com`、`google`→`https://generativelanguage.googleapis.com`、`302ai`→`https://api.302.ai/v1`。
  - `api_key`与`model_id`：优先读取`translator_platform_{平台}_apikey`与`translator_platform_{平台}_model_id`。
- 广谱读取增强（函数`readLLMFromLocalStorage`）：
  - 支持`snake_case`与`camelCase`（`base_url/baseUrl`、`api_key/apiKey/token`、`model_id/modelId/model`）。
  - 支持嵌套对象命名空间（`llm/ai/config/openai`）。
  - 支持`model`对象的`id/name`。
  - 优先使用“当前平台”读取，避免遍历时误选旧平台键。
- 请求构造（函数`translateTextOnce`）：
  - 优先使用当前输入框的值；
  - 勾选“使用主页配置”或输入为空时，按“平台感知同步”与“广谱读取增强”回退；
  - 任一值缺失时输出清晰错误并不发起请求：`**缺少LLM配置**：请在首页或此页填写 base_url / api_key / model_id`。
- UI 调整：
  - 容器最大宽度由`960px`提升为`1200px`。
  - 原文文本域行数由`16/20`提升为`24`（`<textarea id="ot_input" rows="24">`）。
  - 译文结果区最小高度由`12rem`提升为`20rem`（`<pre id="ot_output" style="min-height: 20rem">`）。

## 键值约定与解析
- 当前平台键（优先）：`translator_platform_selected`、`dt_selected_platform`、`ai_platform`、`llm_platform`。
- 自定义接口地址：`translator_platform_custom_base_url`。
- 平台专属键：`translator_platform_{平台}_apikey`、`translator_platform_{平台}_model_id`。
- 兼容键（回退）：`llm_base_url`、`llm_api_key`、`llm_model_id`、以及其它常见命名（如`base_url`、`api_key`、`model_id`）。

## 同步与回退流程（简化）
1. 初始化：若`#use_home_cfg`为`checked`，调用`applyHomeCfg()`并禁用输入框。
2. 事件：`storage`/`visibilitychange`触发→在勾选状态下`applyHomeCfg()`。
3. 翻译前：
   - 取输入框；
   - 若勾选或缺失→按平台键与兼容键回退→必要时`readLLMFromLocalStorage()`广谱扫描；
   - 任一字段缺失→报错并停止。

## 使用说明
- 在主页切换平台或修改`base_url/api_key/model_id`后，返回`/text`页面即可自动同步（或保持页面打开，变更会通过`storage`事件同步）。
- 取消“使用主页配置”开关可手动输入并本地持久化（`llm_*`键）。

## 改进建议
- 主页显式写入`translator_platform_selected`以消除平台推断的时序不确定性。
- 首次加载时清理过期的`translator_platform_*`旧键，降低误读概率。
- 在主页展示当前平台的`base_url/api_key/model_id`来源标记，提升可观察性。