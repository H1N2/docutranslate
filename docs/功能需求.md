# DocuTranslate 功能需求文档

## 1. 概述
DocuTranslate 是一款本地优先、基于工作流架构的多格式文档翻译工具，提供 Web UI 与 REST API，支持异步并发与术语对齐。

## 2. 核心目标
- 支持多格式文档在尽量保留结构的前提下进行高质量机器翻译。
- 提供统一工作流接口以简化不同文档类型的处理与扩展。
- 提供本地可部署的交互式界面与可编程 API。

## 3. 支持格式
- 输入：`pdf`、`docx`、`xlsx`、`md`、`txt`、`json`、`epub`、`srt`、`ass`、`html`、图片（经 Markdown 化）。
- 输出：`html`、`md`、`md(zip)`、`txt`、`json`、`xlsx/csv`、`docx`、`srt`、`epub`、`ass`。

## 4. 架构与工作流
- Workflow 列表与流程：
  - `MarkdownBasedWorkflow`：文件→Markdown→翻译→导出。
  - `TXTWorkflow`：txt→翻译→导出。
  - `JsonWorkflow`：json→翻译→导出（支持 JSONPath 选择）。
  - `DocxWorkflow`、`XlsxWorkflow`、`SrtWorkflow`、`EpubWorkflow`、`HtmlWorkflow`、`AssWorkflow`。
- 转换引擎：`mineru`（在线，需 token，有效期 14 天）、`docling`（本地，首次下载模型）。
- 翻译引擎：可配置 `base_url`、`api_key`、`model_id`，支持主流平台与并发。

## 5. 功能需求
- 必须（Must）
  - 提供交互式 Web UI 与 `docutranslate -i [-p]` 启动入口；提供 `http://127.0.0.1:8010/docs` API 文档。
  - 提供文件上传、状态查询、日志流、结果下载与内容导出（Base64 JSON）。
  - 支持自动术语表生成与术语字典注入；支持分块与并发配置。
  - 支持 PDF 表格/公式/代码识别；支持 Word/Excel 保留格式翻译。
- 应该（Should）
  - 支持局域网多用户访问；支持离线公式渲染（KaTeX）。
  - 提供错误标记与任务取消/释放机制；任务临时文件自动清理。
- 可以（Nice-to-have）
  - 在 UI 中提供导出为 PDF 的能力。

## 6. 非功能需求
- 性能：异步并发，`concurrent` 可配置；长任务提供日志流与状态轮询。
- 可靠性：任务状态内存管理，服务重启后任务丢失需提示与保护策略。
- 可扩展：新增工作流/导出器/转换器需通过配置对象组合，无需修改核心流程。

## 7. 配置与环境
- 需要 `base_url`、`api_key`、`model_id`（示例：OpenAI、智谱、火山、DeepSeek、阿里云百炼等）。
- PDF 解析：`mineru_token` 或本地 `docling` 模型（可通过 Release 资源包）。
- 端口：默认 `8010`，可通过 `-p` 或环境变量 `DOCUTRANSLATE_PORT` 指定。

## 8. API 概述
- `POST /service/translate`：提交带 `workflow_type` 的任务，返回 `task_id`。
- `GET /service/status/{task_id}`：查询任务状态与可下载项。
- `GET /service/logs/{task_id}`：流式增量日志。
- `GET /service/download/{task_id}/{file_type}`：下载结果文件。
- `GET /service/attachment/{task_id}/{identifier}`：下载附件（如术语表）。
- `GET /service/content/{task_id}/{file_type}`：以 Base64 JSON 方式返回内容。
- `POST /service/cancel/{task_id}`、`POST /service/release/{task_id}`：取消与释放任务。

## 9. 数据与文件
- 任务以 `task_id` 为键管理状态、日志、临时与可下载文件；完成后支持多类型导出。
- 内容导出支持 HTML/Markdown/TXT/JSON 等；附件用于术语表等增值产物。

## 10. 兼容性与部署
- 提供 Windows/Mac 懒人包；Python 包支持 `pip` 与 `uv` 安装；支持局域网访问。
- 推荐浏览器访问 `http://127.0.0.1:8010/`；API 文档 `http://127.0.0.1:8010/docs`。

## 11. 风险与限制
- PDF 转 Markdown 会**丢失排版**；严格排版场景需谨慎或后处理。
- `mineru` token 有效期与网络波动；`docling` 首次模型下载可能受网络影响。

## 12. 验收标准
- 能在本地成功启动 Web UI 与 API。
- 能完成各支持格式的示例翻译与正确导出。
- API 能返回期望状态、日志与文件；术语表生成功能可验证。